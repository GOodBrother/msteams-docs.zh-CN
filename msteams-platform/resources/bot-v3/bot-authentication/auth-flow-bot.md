---
title: Bot 的身份验证流
description: 描述 bot 中的身份验证流
keywords: 团队身份验证流 bot
ms.date: 03/01/2018
ms.openlocfilehash: 5230a94b23f9042d9d7753b52467fba5b2fec89e
ms.sourcegitcommit: 4329a94918263c85d6c65ff401f571556b80307b
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 02/01/2020
ms.locfileid: "41673490"
---
# <a name="microsoft-teams-authentication-flow-for-bots"></a><span data-ttu-id="9e13f-104">适用于 bot 的 Microsoft 团队身份验证流</span><span class="sxs-lookup"><span data-stu-id="9e13f-104">Microsoft Teams authentication flow for bots</span></span>

[!include[v3-to-v4-SDK-pointer](~/includes/v3-to-v4-pointer-bots.md)]

<span data-ttu-id="9e13f-105">OAuth 2.0 是一种开放的标准，用于 Azure AD 和许多其他标识提供程序使用的身份验证和授权。</span><span class="sxs-lookup"><span data-stu-id="9e13f-105">OAuth 2.0 is an open standard for authentication and authorization used by Azure AD and many other identity providers.</span></span> <span data-ttu-id="9e13f-106">对 OAuth 2.0 的基本了解是在团队中使用身份验证的先决条件;[下面是一个很好的概述](https://aaronparecki.com/oauth-2-simplified/)，比[正式规范](https://oauth.net/2/)更易于遵循。</span><span class="sxs-lookup"><span data-stu-id="9e13f-106">A basic understanding of OAuth 2.0 is a prerequisite for working with authentication in Teams; [here's a good overview](https://aaronparecki.com/oauth-2-simplified/) that's easier to follow than the [formal specification](https://oauth.net/2/).</span></span> <span data-ttu-id="9e13f-107">选项卡和 bot 的身份验证流略有不同，因为选项卡非常类似于网站，因此它们可以直接使用 OAuth 2.0，而 bot 不是，并且必须以不同方式执行几项操作，但核心概念是相同的。</span><span class="sxs-lookup"><span data-stu-id="9e13f-107">Authentication flow for tabs and bots are a little different because tabs are very similar to websites so they can use OAuth 2.0 directly, and bots are not and must do a few things differently, but the core concepts are identical.</span></span>

<span data-ttu-id="9e13f-108">请参阅 GitHub 存储库[Microsoft 团队身份验证示例](https://github.com/OfficeDev/microsoft-teams-sample-auth-node)，该示例演示使用使用[OAuth 2.0 授权代码授予类型](https://oauth.net/2/grant-types/authorization-code/)的节点的身份验证流。</span><span class="sxs-lookup"><span data-stu-id="9e13f-108">See the GitHub repo [Microsoft Teams Authentication Sample](https://github.com/OfficeDev/microsoft-teams-sample-auth-node) for an example that demonstrates authentication flow for bots using Node using the [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/).</span></span>

![Bot 身份验证序列图](~/assets/images/authentication/bot_auth_sequence_diagram.png)

1. <span data-ttu-id="9e13f-110">用户向 bot 发送一封邮件。</span><span class="sxs-lookup"><span data-stu-id="9e13f-110">The user sends a message to the bot.</span></span>
2. <span data-ttu-id="9e13f-111">机器人确定用户是否需要登录。</span><span class="sxs-lookup"><span data-stu-id="9e13f-111">The bot determines if the user needs to sign in.</span></span>
    * <span data-ttu-id="9e13f-112">在此示例中，机器人将访问令牌存储在其用户数据存储中。</span><span class="sxs-lookup"><span data-stu-id="9e13f-112">In this example, the bot stores the access token in its user data store.</span></span> <span data-ttu-id="9e13f-113">如果没有为选定的标识提供程序验证令牌，则它要求用户登录。</span><span class="sxs-lookup"><span data-stu-id="9e13f-113">It asks the user to log in if it doesn't have a validated token for the selected identity provider.</span></span> <span data-ttu-id="9e13f-114">（[查看代码](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76)）</span><span class="sxs-lookup"><span data-stu-id="9e13f-114">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/utils/AuthenticationUtils.ts#L58-L76))</span></span>
3. <span data-ttu-id="9e13f-115">机器人将 URL 构造到身份验证流的起始页，并将卡片发送给具有`signin`操作的用户。</span><span class="sxs-lookup"><span data-stu-id="9e13f-115">The bot constructs the URL to the start page of the authentication flow, and sends a card to the user with a `signin` action.</span></span> <span data-ttu-id="9e13f-116">（[查看代码](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190)）</span><span class="sxs-lookup"><span data-stu-id="9e13f-116">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L160-L190))</span></span>
    * <span data-ttu-id="9e13f-117">与团队中的其他应用程序身份验证流一样，起始页必须位于`validDomains`列表中的域中，并且在与登录后重定向页面相同的域中。</span><span class="sxs-lookup"><span data-stu-id="9e13f-117">Like other application auth flows in Teams, the start page must be on a domain that's in your `validDomains` list, and on the same domain as the post-login redirect page.</span></span>
    * <span data-ttu-id="9e13f-118">**重要说明**： OAuth 2.0 授权代码授予对身份验证请求`state`中的参数的流调用，其中包含唯一会话令牌，以防止[跨站点请求伪造攻击](https://en.wikipedia.org/wiki/Cross-site_request_forgery)。</span><span class="sxs-lookup"><span data-stu-id="9e13f-118">**IMPORTANT**: The OAuth 2.0 authorization code grant flow calls for a `state` parameter in the authentication request which contains a unique session token to prevent a [cross-site request forgery attack](https://en.wikipedia.org/wiki/Cross-site_request_forgery).</span></span> <span data-ttu-id="9e13f-119">该示例使用随机生成的 GUID。</span><span class="sxs-lookup"><span data-stu-id="9e13f-119">The example uses a randomly-generated GUID.</span></span>
4. <span data-ttu-id="9e13f-120">当用户单击*登录按钮时*，团队会打开一个弹出窗口，并将其导航到起始页。</span><span class="sxs-lookup"><span data-stu-id="9e13f-120">When the user clicks on the *signin* button, Teams opens a popup window and navigates it to the start page.</span></span>
5. <span data-ttu-id="9e13f-121">起始页将用户重定向到标识提供程序的`authorize`终结点。</span><span class="sxs-lookup"><span data-stu-id="9e13f-121">The start page redirects the user to the identity provider's `authorize` endpoint.</span></span> <span data-ttu-id="9e13f-122">（[查看代码](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56)）</span><span class="sxs-lookup"><span data-stu-id="9e13f-122">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/public/html/auth-start.html#L51-L56))</span></span>
6. <span data-ttu-id="9e13f-123">在提供程序的网站上，用户登录并授予对机器人的访问权限。</span><span class="sxs-lookup"><span data-stu-id="9e13f-123">On the provider's site, the user signs in and grants access to the bot.</span></span>
7. <span data-ttu-id="9e13f-124">提供程序使用授权代码将用户带到 bot 的 OAuth 重定向页面。</span><span class="sxs-lookup"><span data-stu-id="9e13f-124">The provider takes the user to the bot's OAuth redirect page, with an authorization code.</span></span>
8. <span data-ttu-id="9e13f-125">Bot 兑现访问令牌的授权代码，并且**临时**会将令牌与启动登录流的用户相关联。</span><span class="sxs-lookup"><span data-stu-id="9e13f-125">The bot redeems the authorization code for an access token, and **provisionally** associates the token with the user that initiated the sign-in flow.</span></span> <span data-ttu-id="9e13f-126">在下面，我们称之为*临时令牌*。</span><span class="sxs-lookup"><span data-stu-id="9e13f-126">Below, we call this a *provisional token*.</span></span>
    * <span data-ttu-id="9e13f-127">在此示例中，机器人将`state`参数值与启动登录进程的用户的 id 关联，以便以后能够将其与标识提供程序返回的`state`值相匹配。</span><span class="sxs-lookup"><span data-stu-id="9e13f-127">In the example, the bot associates the value of the `state` parameter with the id of the user that initiated the sign-in process so it can later match it with the `state` value returned by the identity provider.</span></span> <span data-ttu-id="9e13f-128">（[查看代码](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99)）</span><span class="sxs-lookup"><span data-stu-id="9e13f-128">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L70-L99))</span></span>
    * <span data-ttu-id="9e13f-129">**重要说明**：机器人存储从标识提供程序接收的令牌，并将其与特定用户相关联，但它被标记为 "挂起验证"。</span><span class="sxs-lookup"><span data-stu-id="9e13f-129">**IMPORTANT**: The bot stores the token it receives from the identity provider and associates it with a specific user, but it is marked as "pending validation".</span></span> <span data-ttu-id="9e13f-130">临时令牌尚不能使用：必须进一步对其进行验证：</span><span class="sxs-lookup"><span data-stu-id="9e13f-130">The provisional token cannot be used yet: it must be further validated:</span></span> 
      1. <span data-ttu-id="9e13f-131">**验证从标识提供程序收到的内容。**</span><span class="sxs-lookup"><span data-stu-id="9e13f-131">**Validate what's received from the identity provider.**</span></span> <span data-ttu-id="9e13f-132">必须根据先前保存`state`的内容确认参数的值。</span><span class="sxs-lookup"><span data-stu-id="9e13f-132">The value of the `state` parameter must be confirmed against what was saved earlier.</span></span> 
      1. <span data-ttu-id="9e13f-133">**验证从团队收到的内容。**</span><span class="sxs-lookup"><span data-stu-id="9e13f-133">**Validate what's received from Teams.**</span></span> <span data-ttu-id="9e13f-134">执行[两步身份验证](https://en.wikipedia.org/wiki/Man-in-the-middle_attack)验证，以确保通过标识提供程序向 bot 授权的用户是与 bot 聊天的用户。</span><span class="sxs-lookup"><span data-stu-id="9e13f-134">A [two-step authentication](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) validation is performed to ensure that the user who authorized the bot with the identity provider is the same user who is chatting with the bot.</span></span> <span data-ttu-id="9e13f-135">这将抵御[中间人](https://en.wikipedia.org/wiki/Man-in-the-middle_attack)攻击和[网络钓鱼](https://en.wikipedia.org/wiki/Phishing)攻击。</span><span class="sxs-lookup"><span data-stu-id="9e13f-135">This guards against [man-in-the-middle](https://en.wikipedia.org/wiki/Man-in-the-middle_attack) and [phishing](https://en.wikipedia.org/wiki/Phishing) attacks.</span></span> <span data-ttu-id="9e13f-136">机器人生成验证代码并存储它，与用户相关联。</span><span class="sxs-lookup"><span data-stu-id="9e13f-136">The bot generates a verification code and stores it, associated with the user.</span></span> <span data-ttu-id="9e13f-137">由团队自动发送验证代码，如下面的步骤9和10中所述。</span><span class="sxs-lookup"><span data-stu-id="9e13f-137">The verification code is sent automatically by Teams as described below in steps 9 and 10.</span></span> <span data-ttu-id="9e13f-138">（[查看代码](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113)）</span><span class="sxs-lookup"><span data-stu-id="9e13f-138">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/AuthBot.ts#L100-L113))</span></span>
9. <span data-ttu-id="9e13f-139">OAuth 回调将呈现一个调用`notifySuccess("<verification code>")`的页面。</span><span class="sxs-lookup"><span data-stu-id="9e13f-139">The OAuth callback renders a page that calls `notifySuccess("<verification code>")`.</span></span> <span data-ttu-id="9e13f-140">（[查看代码](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs)）</span><span class="sxs-lookup"><span data-stu-id="9e13f-140">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/master/src/views/oauth-callback-success.hbs))</span></span>
10. <span data-ttu-id="9e13f-141">团队关闭弹出窗口，并将`<verification code>`发送到`notifySuccess()`的自动程序发送回机器人。</span><span class="sxs-lookup"><span data-stu-id="9e13f-141">Teams closes the popup and sends the `<verification code>` sent to `notifySuccess()` back to the bot.</span></span> <span data-ttu-id="9e13f-142">Bot 接收带有`name = signin/verifyState`的[调用](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke)邮件。</span><span class="sxs-lookup"><span data-stu-id="9e13f-142">The bot receives an [invoke](/bot-framework/dotnet/bot-builder-dotnet-activities#invoke) message with `name = signin/verifyState`.</span></span>
11. <span data-ttu-id="9e13f-143">Bot 将检查传入验证代码，以防止使用用户的临时令牌存储的验证代码。</span><span class="sxs-lookup"><span data-stu-id="9e13f-143">The bot checks the incoming verification code against the verification code stored with the user's provisional token.</span></span> <span data-ttu-id="9e13f-144">（[查看代码](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140)）</span><span class="sxs-lookup"><span data-stu-id="9e13f-144">([View code](https://github.com/OfficeDev/microsoft-teams-sample-auth-node/blob/469952a26d618dbf884a3be53c7d921cc580b1e2/src/dialogs/BaseIdentityDialog.ts#L127-L140))</span></span>
12. <span data-ttu-id="9e13f-145">如果匹配，则机器人标记令牌为已验证，可供使用。</span><span class="sxs-lookup"><span data-stu-id="9e13f-145">If they match, the bot marks the token as validated and ready for use.</span></span> <span data-ttu-id="9e13f-146">否则，身份验证流将失败，并且 bot 会删除临时令牌。</span><span class="sxs-lookup"><span data-stu-id="9e13f-146">Otherwise, the auth flow fails, and the bot deletes the provisional token.</span></span>

> [!Note]
> <span data-ttu-id="9e13f-147">如果你在移动时遇到身份验证问题，请确保你的 Javascript SDK 更新到版本1.4.1 或更高版本。</span><span class="sxs-lookup"><span data-stu-id="9e13f-147">If you experience issues with authentication on mobile, ensure your Javascript SDK is update to version 1.4.1 or later.</span></span>

## <a name="samples"></a><span data-ttu-id="9e13f-148">示例</span><span class="sxs-lookup"><span data-stu-id="9e13f-148">Samples</span></span>

<span data-ttu-id="9e13f-149">有关显示 bot 身份验证过程的示例代码，请参阅：</span><span class="sxs-lookup"><span data-stu-id="9e13f-149">For sample code showing the bot authentication process see:</span></span>

* [<span data-ttu-id="9e13f-150">Microsoft 团队 bot 身份验证示例（节点）</span><span class="sxs-lookup"><span data-stu-id="9e13f-150">Microsoft Teams bot authentication sample (Node)</span></span>](https://github.com/OfficeDev/microsoft-teams-sample-auth-node)

## <a name="more-details"></a><span data-ttu-id="9e13f-151">更多详细信息</span><span class="sxs-lookup"><span data-stu-id="9e13f-151">More details</span></span>

<span data-ttu-id="9e13f-152">有关针对 Azure Active Directory 的 bot 身份验证的详细实施演练，请参阅：</span><span class="sxs-lookup"><span data-stu-id="9e13f-152">For detailed implementation walkthroughs for bot authentication targeting Azure Active Directory see:</span></span>

* [<span data-ttu-id="9e13f-153">在 Microsoft 团队 bot 中对用户进行身份验证</span><span class="sxs-lookup"><span data-stu-id="9e13f-153">Authenticate a user in a Microsoft Teams bot</span></span>](~/resources/bot-v3/bot-authentication/auth-bot-AAD.md)
